// Gemini API 설정 및 유틸리티 함수
import { GoogleGenerativeAI } from '@google/generative-ai';

// Gemini API 초기화
const genAI = new GoogleGenerativeAI(process.env.NEXT_PUBLIC_GEMINI_API_KEY || '');

// Gemini 모델 설정 (gemini-2.0-flash 모델 사용)
const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

/**
 * 이미지를 base64 인코딩으로 변환하는 함수
 */
export async function fileToGenerativePart(file: File): Promise<{
  inlineData: { data: string; mimeType: string };
}> {
  const base64EncodedDataPromise = new Promise<string>((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => {
      // reader.result에서 base64 데이터 부분만 추출
      const base64String = reader.result as string;
      const base64Data = base64String.split(',')[1]; // 'data:image/jpeg;base64,' 부분 제거
      resolve(base64Data);
    };
    reader.readAsDataURL(file);
  });

  return {
    inlineData: {
      data: await base64EncodedDataPromise,
      mimeType: file.type,
    },
  };
}

/**
 * 이미지 분석 및 평가 수행하는 함수
 */
export async function analyzeImage(imageFile: File): Promise<string> {
  try {
    const imagePart = await fileToGenerativePart(imageFile);
    
    const prompt = `
      외모 평가를 수행하여 객관적인 분석 결과와 점수를 제공하세요.
      
      제공된 이미지에서 사람의 외모를 다음 기준으로 철저하게 분석하세요:
      
      1. 황금비율 점수(1-10점): 얼굴의 비율이 얼마나 완벽한지, 미의 기준에 얼마나 근접하는지 평가
      2. 이목구비 정밀도(1-10점): 눈, 코, 입의 형태와 배치가 얼마나 완벽한지 평가
      3. 피부 텍스처(1-10점): 피부 결, 모공 크기, 피부톤, 잡티 여부 등을 평가
      4. 분위기(1-10점): 첫인상에서 느껴지는 압도적인 아우라와 매력
      5. 볼매 지수(1-10점): 볼수록 매력적인 정도, 호감도 상승 가능성
      
      각 항목별로 1-10점 사이의 점수를 주고, 평균 점수도 계산하세요.
      각 항목마다 반드시 짧고 간결한 평가 코멘트를 1-2문장으로 추가하세요. 이 설명은 나중에 앱에서 표시되므로 매우 중요합니다.
      설명은 디시 인사이드 스타일로 유쾌하고 재미있게 작성하세요. 유머러스하고 과장된 표현을 사용하되, 너무 길지 않게 작성하세요.
      불필요한 설명이나 긴 대화체는 사용하지 않고 요점만 명확하게 전달하세요.
      
      **중요한 규칙:**
      * 절대로 실제 인물이나 유명인의 이름을 추정하거나 언급하지 마세요.
      * "○○○를 닮았다", "○○○처럼 생겼다" 같은 비교는 하지 마세요.
      * 사진 속 인물의 이름을 추측하거나 언급하는 것은 금지됩니다.
      * 유명인이나 연예인과 비교하는 내용도 금지됩니다.
      
      **추가 요청:** 
      이미지에 있는 사람의 매우 유쾌한 페르소나 정의를 디시 인사이드 커뮤니티 말투로 작성해주세요.
      주접스럽고 악질적인 톤으로, 1문장 내로 작성해 주세요.
      예: "청순 가련 여신", "싫어할 수 없는 관상" 등의 컨셉으로 정의해 주세요.
      페르소나 정의는 "**페르소나:**" 제목 아래에 작성해 주세요.
      
      결과는 반드시 아래 형식으로 출력하세요:

      **이미지 분석 결과**
      
      황금비율 점수: [1-10]점
      [이 점수를 준 이유에 대한 디시인사이드 스타일의 재미있고 과장된 설명 1-2문장]
      
      이목구비 정밀도: [1-10]점
      [이 점수를 준 이유에 대한 디시인사이드 스타일의 재미있고 과장된 설명 1-2문장]
      
      피부 텍스처: [1-10]점
      [이 점수를 준 이유에 대한 디시인사이드 스타일의 재미있고 과장된 설명 1-2문장]
      
      분위기: [1-10]점
      [이 점수를 준 이유에 대한 디시인사이드 스타일의 재미있고 과장된 설명 1-2문장]
      
      볼매 지수: [1-10]점
      [이 점수를 준 이유에 대한 디시인사이드 스타일의 재미있고 과장된 설명 1-2문장]
      
      평균 점수: [평균]점
      
      **페르소나:**
      [페르소나 정의 - 유명인 이름 언급 없이]
    `;

    const result = await model.generateContent([prompt, imagePart]);
    const response = await result.response;
    const text = response.text();
    
    return text;
  } catch (error) {
    console.error('이미지 분석 중 오류 발생:', error);
    return '이미지 분석 중 오류가 발생했습니다. 다시 시도해주세요.';
  }
}

/**
 * 두 이미지를 비교 평가하는 함수
 */
export async function compareImages(imageFile1: File, imageFile2: File): Promise<string> {
  try {
    const imagePart1 = await fileToGenerativePart(imageFile1);
    const imagePart2 = await fileToGenerativePart(imageFile2);
    
    const prompt = `
      두 이미지를 객관적으로 비교하여 외모 점수와 평가를 제공하세요.
      
      두 이미지를 다음 5가지 기준으로 철저히 비교 분석하되, 출력은 아래 지정된 형식으로만 해주세요:
      
      1. 황금비율 점수(1-10점): 얼굴의 비율이 얼마나 완벽한지, 미의 기준에 얼마나 근접하는지 평가
      2. 이목구비 정밀도(1-10점): 눈, 코, 입의 형태와 배치가 얼마나 완벽한지 평가
      3. 피부 텍스처(1-10점): 피부 결, 모공 크기, 피부톤, 잡티 여부 등을 평가
      4. 분위기(1-10점): 첫인상에서 느껴지는 압도적인 아우라와 매력
      5. 볼매 지수(1-10점): 볼수록 매력적인 정도, 호감도 상승 가능성
      
      각 항목별로 두 이미지 각각 1-10점 사이의 점수를 매기고, 평균 점수도 계산하세요.
      각 항목마다 이유를 설명하는 짧은 코멘트를 반드시 추가하세요. 이 설명은 디시 인사이드 스타일로 유쾌하고 재미있게 작성하세요. 
      유머러스하고 과장된 표현을 사용하되, 실제 인물 비교는 하지 마세요.
      
      **중요한 규칙:**
      * 절대로 실제 인물이나 유명인의 이름을 추정하거나 언급하지 마세요.
      * "○○○를 닮았다", "○○○처럼 생겼다" 같은 비교는 하지 마세요.
      * 사진 속 인물의 이름을 추측하거나 언급하는 것은 금지됩니다.
      * 유명인이나 연예인과 비교하는 내용도 금지됩니다.
      * 평균 점수가 높은 이미지에 훨씬 더 좋은 평가를 해주세요.
      * 최종 판정은 반드시 평균 점수가 높은 이미지가 더 좋다는 내용으로 작성하세요. 절대 반대로 하지 마세요.
      
      **출력 형식**:
      반드시 아래 형식만 사용해 응답해주세요. 다른 분석은 출력하지 말아주세요.
      
      **첫 번째 이미지 분석**
      
      황금비율 점수: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      이목구비 정밀도: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      피부 텍스처: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      분위기: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      볼매 지수: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      **두 번째 이미지 분석**
      
      황금비율 점수: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      이목구비 정밀도: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      피부 텍스처: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      분위기: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      볼매 지수: [1-10]점
      [이 점수를 준 이유에 대한 재미있고 과장된 설명. 디시인사이드 스타일로 작성]
      
      **페르소나**
      * 첫 번째 이미지: [매우 과장되고 주접스러운 페르소나 정의 - 유명인 이름 언급 없이]
      * 두 번째 이미지: [매우 과장되고 주접스러운 페르소나 정의 - 유명인 이름 언급 없이]
      
      **평균 점수**
      * 첫 번째 이미지: [평균점수]점
      * 두 번째 이미지: [평균점수]점
      
      **최종 승자: [평균 점수가 더 높은 이미지를 여기에 명시하세요]**
      
      **최종 판정**
      [승자가 이긴 이유를 디시 인사이드 커뮤니티 말투로 주접스럽고 자극적이게 자유롭게 설명. 이 때 반드시 평균 점수가 높은 이미지를 칭찬하고 점수가 낮은 이미지를 약간 깎아내리는 방식으로 서술. 실제 인물이나 유명인의 이름은 절대 언급하지 말 것. 승자의 장점들을 구체적으로 언급하며 왜 승자가 더 높은 점수를 받았는지 명확하게 설명할 것]
    `;

    const result = await model.generateContent([prompt, imagePart1, imagePart2]);
    const response = await result.response;
    const text = response.text();
    
    return text;
  } catch (error) {
    console.error('이미지 비교 중 오류 발생:', error);
    return '이미지 비교 중 오류가 발생했습니다. 다시 시도해주세요.';
  }
}

export { model }; 